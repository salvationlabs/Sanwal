{% extends 'store/layout.html' %}
{% load static %}

{% block title %}Basket Summary{% endblock %}

{% block body %}
	<div class="container pt-5">
		<h1 class="h5">Shopping Basket</h1>
		{% if not basket %}
		<p class="mb-4 text-muted">Your Basket is empty.</p>
		{% endif %}
		{% for item in basket %}
		{% with product=item.product %}
		<div data-index="{{ product.id }}" class="row mb-4 border product-item">
			<div class="col-md-3 col-lg-2 order-md-first bg-light">
				<img src="{{ product.img.first.image.url }}" alt="Responsive image" width="120px" class="img-fluid mx-auto d-block">
			</div>
			<div class="col-md-9 col-lg-10 ps-md-3 ps-lg-10">
				<a href="{{ product.get_absolute_url }}" class="text-decoration-none text-reset"><h1 class="h5 pt-2">{{ product.title }}</h1></a>
				<div class="border">
					<div class="col border-bottom">
						<div class="row p-3">
							<div class="col-6">Hardback Book</div>
							<div class="col-6 text-end"><span class="h6 fw-bold">Rs. {{ product.price }}</span></div>
						</div>
					</div>
					<div class="col">
						<div class="row p-2">
							<div class="col-10 m-auto">
								Qty
								<button class="plus-btn btn p-0" type="button" data-index="{{ product.id }}"><ion-icon name="add-outline"></ion-icon></button>
								<span class="quantity">{{ item.qty }}</span>
								<button type="button" class="min-btn btn p-0" data-index="{{ product.id }}"><ion-icon name="remove-outline"></ion-icon></button>
							</div>
							<div class="col">
								<button type="button" data-index="{{ product.id }}" class="btn btn-outline-danger dlt-btn">Remove Item</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		{% endwith %}
		{% endfor %}
		<div class="col-12 text-end">
			<div class="h6 text-muted">Sub Total: Rs. <span id="sub-total" class="text-success">{{ basket.get_total_price }}</span></div>
			<a href="{% url 'store:index' %}" {% if basket %} class="btn basket filled mb-5" {% endif %} class="btn basket mb-5">Continue Shopping</a>
			{% if basket %}
			<a href="{% url 'payment:payment' %}" class="btn basket mb-5">Proceed to Checkout</a>
			{% endif %}
		</div>
	</div>

	<script>
		// Quantity Change
		$('.plus-btn').on('click', function (e) {
			e.preventDefault();
			$(this).siblings('.quantity').text(parseInt($(this).siblings('.quantity').text()) + 1);
			updateBasket($(this));
		})
		$('.min-btn').on('click', function (e) {
			e.preventDefault();
			let quantity = parseInt($(this).siblings('.quantity').text());
			if(quantity > 1)
			{
				$(this).siblings('.quantity').text(quantity - 1);
				updateBasket($(this));
			}
		})

		const updateBasket = function (btn) {
			// add to basket
			var csrfToken = "{{ csrf_token }}";
			$.ajax({
				type: "POST",
				url: "{% url 'basket:basket_update' %}",
				data: {
					productId: btn.data('index'),
					product_qty: parseInt(btn.siblings('.quantity').text()),
					csrfmiddlewaretoken: csrfToken,
					action: 'update'
				},
				success: function (response) {
					$('.basket-qty').text(response.qty);
					$('#sub-total').text(response.subtotal);
				},
				error: function (xhr, errmessage, err) {}
			});
		}
		// add to basket
		$(document).on('click', '.dlt-btn', function (e) {
			e.preventDefault();
			const product_id = $(this).data('index');
			var csrfToken = "{{ csrf_token }}";
			$.ajax({
				type: "POST",
				url: "{% url 'basket:basket_update' %}",
				data: {
					productId: product_id,
					csrfmiddlewaretoken: csrfToken,
					action: 'delete'
				},
				success: function (response) {
					if (response.qty == '0') {
						$('.basket-qty').text('');
						$('.btn.basket:nth-of-type(2)').remove();
						$('.btn.basket:nth-of-type(1)').removeClass('filled');
						$('.container > h1').after('<p class="mb-4 text-muted">Your Basket is empty.</p>');
					}
					else
					{
						$('.basket-qty').text(response.qty);
					}
					$('#sub-total').text(response.subtotal);
					$(`.product-item[data-index="${product_id}"]`).remove();
				},
				error: function (xhr, errmessage, err) {}
			});
		})
	</script>
{% endblock %}