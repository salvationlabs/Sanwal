{% extends 'store/layout.html' %}
{% load static %}

{% block title %}Basket Summary{% endblock %}

{% block body %}
	<div class="container pt-4">
		<h1 class="h5 hstack gap-3" style="color: wheat;">
			<a href="{% url 'store:index' %}" class="link-body-emphasis text-decoration-none">
				<img src="{% static 'store/imgs/icon/sanwal2.webp' %}" alt="Logo" width="50" height="45">
			</a><div class="vr me-2"></div>
			Your Shopping Basket
		</h1>
		{% if not basket %}
		<p class="mb-4 text-muted">Your Basket is empty.</p>
		{% endif %}
		{% for item in basket %}
		{% with product=item.product %}
		<div data-index="{{ product.id }}" class="row col-10 my-4 p-3 product-item m-auto rounded-4 gx-0" style="max-width: 60rem; box-shadow: inset -5px -5px 10px rgba(255, 255, 255, 0.05), inset 5px 5px 15px rgba(0, 0, 0, 0.5); background-color: #141414;">
			<!--------------- Image ----------------->
			<div class="col-1 order-md-first m-auto">
				{% if product.img.first.image %}
				{% comment %}
				<div class="swiper itemImageSwiper" style="width: 50px;">
					<div class="swiper-wrapper">
						{% for image in product.img.all %}
							<div class="swiper-slide">
								<img src="{{ image.image.url }}" alt="{{ image.image }}" style="border-radius: 50%; height: 70px; width: 70px;">
							</div>
						{% endfor %}
					</div>
				</div>
				{% endcomment %}
				<img src="{{ product.img.first.image.url }}" alt="{{ product.title }} image" style="border-radius: 50%; height: 70px; width: 70px;" class="img-fluid">
				{% else %}
				<img src="{% static 'store\imgs\products\No_image_available.png' %}" class="card-img-top" alt="No image available">
				{% endif %}
			</div>
			<!------------- Product Body ------------>
			<div class="row col-5 col-lg-9 m-auto">
				<a href="{{ product.get_absolute_url }}" class="text-decoration-none text-reset col-4">
					<h1 class="h5">{{ product.title }}</h1>
					<h2 class="h6">Ref. {{ product.id }}</h1>
				</a>
				<div class="col-2 m-auto">{{  product.material }}</div>
				<div class="col-2 m-auto">
					<button class="plus-btn btn p-0" type="button" data-index="{{ product.id }}"><ion-icon name="add-outline"></ion-icon></button>
					<span class="quantity">{{ item.qty }}</span>
					<button type="button" class="min-btn btn p-0" data-index="{{ product.id }}"><ion-icon name="remove-outline"></ion-icon></button>
				</div>
				<div class="col-2 m-auto">Rs. {{  product.price }}</div>
			</div>
			<div class="col-1 my-auto">
				<span type="button" data-index="{{ product.id }}" class="dlt-btn"><ion-icon name="close-outline" style="font-size: 25px;"></ion-icon></span>
			</div>
		</div>
		{% endwith %}
		{% endfor %}
		<div class="row g-1 col-11 text-end">
			<div class="h6 text-muted">Sub Total: <span id="sub-total" class="text-light ms-4">Rs. {{ basket.get_total_price }}</span></div>
			<a href="{% url 'store:index' %}" {% if basket %} class="col-2 btn basket filled" {% endif %} class="btn basket">Continue Shopping</a>
			{% if basket %}
			<a href="{% url 'payment:checkout' %}" class="col-3 offset-md-9 btn basket mb-5">Proceed to Checkout</a>
			{% endif %}
		</div>
	</div>

	<script>
		// Quantity Change
		$('.plus-btn').on('click', function (e) {
			e.preventDefault();
			$(this).siblings('.quantity').text(parseInt($(this).siblings('.quantity').text()) + 1);
			updateBasket($(this));
		})
		$('.min-btn').on('click', function (e) {
			e.preventDefault();
			let quantity = parseInt($(this).siblings('.quantity').text());
			if(quantity > 1)
			{
				$(this).siblings('.quantity').text(quantity - 1);
				updateBasket($(this));
			}
		})

		const updateBasket = function (btn) {
			// add to basket
			var csrfToken = "{{ csrf_token }}";
			$.ajax({
				type: "POST",
				url: "{% url 'basket:basket_update' %}",
				data: {
					productId: btn.data('index'),
					product_qty: parseInt(btn.siblings('.quantity').text()),
					csrfmiddlewaretoken: csrfToken,
					action: 'update'
				},
				success: function (response) {
					$('.basket-qty').text(response.qty);
					$('#sub-total').text(response.subtotal);
				},
				error: function (xhr, errmessage, err) {}
			});
		}
		// add to basket
		$(document).on('click', '.dlt-btn', function (e) {
			e.preventDefault();
			const product_id = $(this).data('index');
			var csrfToken = "{{ csrf_token }}";
			$.ajax({
				type: "POST",
				url: "{% url 'basket:basket_update' %}",
				data: {
					productId: product_id,
					csrfmiddlewaretoken: csrfToken,
					action: 'delete'
				},
				success: function (response) {
					if (response.qty == '0') {
						$('.basket-qty').text('');
						$('.btn.basket:nth-of-type(2)').remove();
						$('.btn.basket:nth-of-type(1)').removeClass('filled');
						$('.container > h1').after('<p class="mb-4 text-muted">Your Basket is empty.</p>');
					}
					else
					{
						$('.basket-qty').text(response.qty);
					}
					$('#sub-total').text(response.subtotal);
					$(`.product-item[data-index="${product_id}"]`).remove();
				},
				error: function (xhr, errmessage, err) {}
			});
		})
	</script>
{% endblock %}